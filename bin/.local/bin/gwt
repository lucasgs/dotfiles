#!/bin/bash

# 1. Setup and Validation
if [ -z "$1" ]; then
    echo "Usage: gtw <branch-name>"
    exit 1
fi

BRANCH_NAME=$1

# Find the MAIN repository path (the first line of git worktree list)
# This ensures we always calculate the base dir relative to the main repo
MAIN_REPO_PATH=$(git worktree list | head -n 1 | awk '{print $1}')

if [ -z "$MAIN_REPO_PATH" ]; then
    echo "Error: Not in a git repository."
    exit 1
fi

# The name of the original repository (e.g., "my-project")
MAIN_REPO_NAME=$(basename "$MAIN_REPO_PATH")

# Hardcoded directory structure: root_dir/{repo_name}-worktrees/
# If MAIN_REPO_PATH is /Users/lucas/work/my-project
# WORKTREE_BASE_DIR becomes /Users/lucas/work/my-project-worktrees
WORKTREE_BASE_DIR="$(dirname "$MAIN_REPO_PATH")/${MAIN_REPO_NAME}-trees"
TARGET_PATH="${WORKTREE_BASE_DIR}/${BRANCH_NAME}"

# Ensure the parent directory for all worktrees exists
mkdir -p "$WORKTREE_BASE_DIR"

# 2. Logic to Check Existence
# Check if the branch exists locally or on a remote
BRANCH_EXISTS=$(git rev-parse --verify "$BRANCH_NAME" 2>/dev/null)

# Check if worktree is already registered
# We use -F for fixed string matching to avoid path regex issues
WORKTREE_EXISTS=$(git worktree list | grep -F "$TARGET_PATH")

if [ -n "$WORKTREE_EXISTS" ]; then
    echo "âœ… Worktree already exists at $TARGET_PATH."
elif [ -n "$BRANCH_EXISTS" ]; then
    echo "ðŸŒ¿ Branch '$BRANCH_NAME' exists. Creating worktree at $TARGET_PATH..."
    git worktree add "$TARGET_PATH" "$BRANCH_NAME"
else
    echo "âœ¨ Creating new branch '$BRANCH_NAME' at $TARGET_PATH..."
    git worktree add -b "$BRANCH_NAME" "$TARGET_PATH"
fi

# 3. Tmux Session Management
# Session name is repo_name:branch_name (sanitized)
SESSION_NAME="${MAIN_REPO_NAME}_${BRANCH_NAME//[\.\/]/_}"

if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "ðŸš€ Starting new Tmux session: $SESSION_NAME"
    tmux new-session -d -s "$SESSION_NAME" -c "$TARGET_PATH"
fi

# 4. Attach or Switch logic
if [ -z "$TMUX" ]; then
    tmux attach-session -t "$SESSION_NAME"
else
    tmux switch-client -t "$SESSION_NAME"
fi
